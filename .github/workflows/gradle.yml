name: Build, Release & Docker Publish

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  packages: write

env:
  FLATLAF_VER: "3.6.2"
  MAIN_CLASS: "expense_income_tracker.ExpensesIncomesTracker"
  JAR_NAME: "ExpenseTracker.jar"
  IMAGE_NAME: "expense-tracker"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install helper packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip

      - name: Download FlatLaf dependency
        run: |
          mkdir -p libs
          curl -L -o libs/flatlaf-${FLATLAF_VER}.jar \
            "https://repo1.maven.org/maven2/com/formdev/flatlaf/${FLATLAF_VER}/flatlaf-${FLATLAF_VER}.jar"

      - name: Compile Java sources
        run: |
          mkdir -p bin
          find . -name "*.java" > sources.txt
          javac -cp "libs/*" -d bin @sources.txt

      - name: Build fat jar
        run: |
          rm -rf tmp_jar tmp_unzip meta
          mkdir -p tmp_jar tmp_unzip meta

          # Copy compiled classes
          cp -r bin/* tmp_jar/

          # Extract dependencies
          for j in libs/*.jar; do unzip -q "$j" -d tmp_unzip; done
          cp -r tmp_unzip/* tmp_jar/ || true

          # Manifest
          echo "Main-Class: ${MAIN_CLASS}" > meta/manifest.txt

          jar cfm ${JAR_NAME} meta/manifest.txt -C tmp_jar .

      - name: Smoke test jar
        run: |
          java -Djava.awt.headless=true -jar ${JAR_NAME} || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExpenseTracker-JAR
          path: ${JAR_NAME}

      - name: Create minimal Dockerfile if missing
        run: |
          if [ ! -f Dockerfile ]; then
            cat << 'EOF' > Dockerfile
FROM eclipse-temurin:17-jre
WORKDIR /app
COPY ExpenseTracker.jar /app/ExpenseTracker.jar
ENTRYPOINT ["java","-jar","/app/ExpenseTracker.jar"]
EOF
            echo "Created Dockerfile"
          else
            echo "Dockerfile exists"
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

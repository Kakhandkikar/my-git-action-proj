name: Java Build, Fat-JAR & Release

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write

env:
  FLATLAF_VER: "3.6.2"
  MAIN_CLASS: "expense_income_tracker.ExpensesIncomesTracker"
  JAR_NAME: "ExpenseTracker.jar"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install helper packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip

      - name: Download FlatLaf dependency
        run: |
          mkdir -p libs
          curl -L -o libs/flatlaf-${FLATLAF_VER}.jar \
            "https://repo1.maven.org/maven2/com/formdev/flatlaf/${FLATLAF_VER}/flatlaf-${FLATLAF_VER}.jar"
          ls -la libs

      - name: Compile Java sources (with libs on classpath)
        run: |
          mkdir -p bin
          # collect Java sources (adjust path if needed)
          find . -name "*.java" > sources.txt
          # compile; include any jars in libs/
          javac -cp "libs/*" -d bin @sources.txt
          echo "Compiled classes:"
          find bin -type f | sed -n '1,40p'

      - name: Create fat (uber) jar including FlatLaf
        run: |
          set -eux
          # prepare temporary layout
          rm -rf tmp_jar tmp_unzip
          mkdir -p tmp_jar

          # copy compiled classes into tmp_jar
          cp -r bin/* tmp_jar/

          # unzip all dependency jars into a temporary folder, then copy classes/resources into tmp_jar
          mkdir -p tmp_unzip
          for j in libs/*.jar; do
            unzip -q -o "$j" -d tmp_unzip
          done

          # copy contents from tmp_unzip into tmp_jar (overwrite duplicates from libs if any)
          cp -r tmp_unzip/* tmp_jar/ || true

          # create manifest with Main-Class
          mkdir -p meta
          echo "Main-Class: ${MAIN_CLASS}" > meta/manifest.txt
          # create the fat jar
          jar cfm ${JAR_NAME} meta/manifest.txt -C tmp_jar .
          # show a quick listing
          jar tf ${JAR_NAME} | sed -n '1,40p'

      - name: Run the jar (smoke test)
        run: |
          # run the jar to ensure it starts (it may open UI; using headless to avoid display issues)
          java -Djava.awt.headless=true -jar ${JAR_NAME} || true
          echo "Smoke run finished (exit code ignored)."

      - name: Upload CI artifact (short-term)
        uses: actions/upload-artifact@v4
        with:
          name: ExpenseTracker-JAR
          path: ${JAR_NAME}

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ github.run_number }}
          release_name: ExpenseTracker-${{ github.run_number }}
          body: Automated release of ExpenseTracker.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JAR to GitHub Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.JAR_NAME }}
          asset_name: ${{ env.JAR_NAME }}
          asset_content_type: application/java-archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

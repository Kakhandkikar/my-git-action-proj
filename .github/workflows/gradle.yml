name: Build, Release & Docker Publish (Docker Hub)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  packages: write

env:
  FLATLAF_VER: "3.6.2"
  MAIN_CLASS: "expense_income_tracker.ExpensesIncomesTracker"
  JAR_NAME: "ExpenseTracker.jar"
  IMAGE_REPO: "${{ secrets.DOCKERHUB_USERNAME }}/${{ github.repository }}"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install helper packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip

      - name: Download FlatLaf dependency
        run: |
          mkdir -p libs
          curl -L -o libs/flatlaf-${FLATLAF_VER}.jar \
            "https://repo1.maven.org/maven2/com/formdev/flatlaf/${FLATLAF_VER}/flatlaf-${FLATLAF_VER}.jar"
          ls -la libs

      - name: Compile Java sources
        run: |
          mkdir -p bin
          find . -name "*.java" > sources.txt
          javac -cp "libs/*" -d bin @sources.txt

      - name: Build fat jar
        run: |
          rm -rf tmp_jar tmp_unzip meta
          mkdir -p tmp_jar tmp_unzip meta
          cp -r bin/* tmp_jar/ || true
          for j in libs/*.jar; do unzip -q "$j" -d tmp_unzip; done
          cp -r tmp_unzip/* tmp_jar/ || true
          echo "Main-Class: ${MAIN_CLASS}" > meta/manifest.txt
          jar cfm ${JAR_NAME} meta/manifest.txt -C tmp_jar .

      - name: Smoke test jar
        run: |
          java -Djava.awt.headless=true -jar ${JAR_NAME} || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExpenseTracker-JAR
          path: ${JAR_NAME}

      - name: Create minimal Dockerfile if missing (safe)
        run: |
          if [ ! -f Dockerfile ]; then
            printf '%s\n' \
              'FROM eclipse-temurin:17-jre' \
              'WORKDIR /app' \
              'COPY ExpenseTracker.jar /app/ExpenseTracker.jar' \
              'ENTRYPOINT ["java","-jar","/app/ExpenseTracker.jar"]' \
              > Dockerfile
            echo "Created Dockerfile"
          else
            echo "Dockerfile exists"
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image to Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            docker.io/${{ env.IMAGE_REPO }}:latest
            docker.io/${{ env.IMAGE_REPO }}:${{ github.sha }}
          # optionally add platforms: linux/amd64,linux/arm64 to enable multi-arch

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ github.run_number }}
          release_name: ExpenseTracker-${{ github.run_number }}
          body: Automated release of ExpenseTracker.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JAR to GitHub Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.JAR_NAME }}
          asset_name: ${{ env.JAR_NAME }}
          asset_content_type: application/java-archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
